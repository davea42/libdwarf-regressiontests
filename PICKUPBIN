#!/bin/sh
# Pick up newly built dwarfdump in two flavors.
# Pick up libdwarf in two flavors.
. ./SHALIAS.sh
# The -fsanitize=address tells gcc to use extra run-time
# code to look for code writing where it should not.
# It should be sufficiently efficient to do by default, but
# we will see.
#  The gcc option is -fsanitize=address and the like

# dwarfgen and libelf go together here.
withlibelf="withlibelf"
libelfopt="--enable-libelf"
if [ $# -eq 0 ]
then
   echo "PICKUPBIN defaults to withlibelf."
fi
if [ $# -gt 0 ]
then
  withlibelf="withlibelf"
  if [ $1 = "nolibelf" ]
  then
    withlibelf="nolibelf"
    echo "PICKUPBIN set to nolibelf."
    libelfopt="--disable-libelf"
  else 
    if [ $1 != "withlibelf" ]
    then
      echo "Improper argument to PICKUPBIN, use withlibelf or nolibelf"
      exit 1
    fi
    echo "PICKUPBIN set to withlibelf."
  fi
fi


if [ x$NLIZE = 'xy' ]
then
sanitize="--enable-sanitize"
else
sanitize=
fi


cur=`pwd`
top_build=/tmp/regressionbuild
if [ ! -d $top_build ]
then
  mkdir $top_build
fi
rm -rf $top_build/*

# Fix the following line to match the desired 
# libdwarf/dwarfdump source 
# directory.
. ./BASEFILES

cd $top_build 
echo "PICKUPBIN configure --disable-libelf for dwarfdumpnl"
set -x
$libdw/configure $sanitize  --disable-libelf ; make
set +x
cp dwarfdump/dwarfdump $cur/dwarfdumpnl

rm -rf $top_build/*
cd $top_build 
set -x
$libdw/configure $sanitize $libelfopt  --enable-oldframecol ;  make
set +x

cp libdwarf/.libs/libdwarf.a $cur/libdwoldframecol.a
if [ $? -ne 0 ]
then
  echo "No libdwoldframecol.a copied! giving up."
  exit 1;
fi

rm -rf $top_build/*

echo "PICKUPBIN configure $libelfop for --enable-windowspath"
set -x
$libdw/configure $sanitize $libelfopt --enable-windowspath ; make 
set +x

cp dwarfdump/dwarfdump   $cur/dwarfdumpW
if [ $? -ne 0 ]
then
  echo "No dwarfdumpW done! giving up."
  exit 1;
fi


rm -rf $top_build/*
if [ $withlibelf = "withlibelf" ]
then
  echo "PICKUPBIN configure --enable-dwarfgen --enable-dwarfexample"
  set -x
  $libdw/configure $sanitize --enable-dwarfgen --enable-dwarfexample ;  make 
  set +x
else
  echo "PICKUPBIN configure --diable-libelf --enable-dwarfexample"
  set -x
  $libdw/configure $sanitize --disable-libelf --enable-dwarfexample ;  make 
  set +x
fi
if [ $? -ne 0 ]
then
  echo "No libdwarf.a built! giving up."
  exit 1;
fi
cp libdwarf/.libs/libdwarf.a $cur/libdwarf.a
if [ $? -ne 0 ]
then
  echo "No libdwarf.a to copy! giving up."
  exit 1;
fi

cp dwarfdump/dwarfdump  $cur/dwarfdump
if [ $? -ne 0 ]
then
  echo "No dwarfdump to copy! giving up."
  exit 1;
fi
cp $libdw/dwarfdump/dwarfdump.conf  $cur/dwarfdump.conf
if [ $? -ne 0 ]
then
  echo "No dwarfdump.conf to copy! giving up."
  exit 1;
fi
if [ $withlibelf = "withlibelf" ]
then
  cp $top_build/dwarfgen/dwarfgen  $cur
  if [ $? -ne 0 ]
  then
    echo "No dwarfgen to copy! giving up."
    exit 1;
  fi
fi
cp $top_build/dwarfexample/simplereader  $cur
if [ $? -ne 0 ]
then
  echo "No simplereader to copy! giving up."
  exit 1;
fi
